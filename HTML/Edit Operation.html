<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>تعديل عملية</title>
	<link rel="stylesheet" href="..\public\CSS\bootstrap.css" />
	<link rel="stylesheet" href="..\public\CSS/jquery-ui.css" />
	<link rel="stylesheet" href="../public/CSS/autoComplate.css" />
	<link rel="stylesheet" href="../public/CSS/bootstrap-file.css" />

	<script src="..\public\Js\jquery-3.6.0.js"></script>
	<script src="../public/Js/functions/autoComplete.js"></script>
	<!-- <script src="../public/Js/jquery-ui.js"></script> -->
	<!-- <script src="../public/Js/jquery-ui-timepicker-addon.min.js"></script> -->
	<!-- <script src="..\public\Js/bootstrap.js"></script> -->
	<!-- <script src="../public/Js/bootstrap.bundle.js"></script> -->
	<script src="../public/Js/functions/autocomplete.js"></script>
	<script src="../public/Js/functions/inputTypeNumber.js"></script>
	<script src="../public/Js/addOperation.js"></script>
	<!-- <script src="../public/Js/printDatetime.js"></script> -->


</head>

<body>


	<!--Begin AddNewOperationNameModal-->
	<div dir='rtl' class="modal" style="background:rgb(0,0,0,0.4)" id="addNewOperationName">
		<div class="modal-dialog modal-dialog-scrollable">
			<div class="modal-content">
				<div dir='rtl' class="modal-header bg-success text-white">
					<h4 class="modal-title">إضافة اسم عملية جديد</h4>
					<button type="button" class="btn-close bg-white" style="margin-left:0;"
						onclick="$('#addNewOperationName').slideUp('fast')"></button>
				</div>
				<div class="modal-body">
					<ul class="list-group-flush">
						<li class="list-group-item text-success">
							<div class="form-group row my-3">
								<div class="col-sm-12">
									<input type="text" class="form-control form-control" id="newName"
										placeholder="الاسم الجديد" />
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div dir="ltr" class="btn-group btn-group-lg">
					<button id='btnAdd' onclick="$('#addNewOperationName').slideUp('fast');addNewOperationName();"
						type="button" class="btn btn-warning">إضافة</button>
					<button type="button" onclick="$('#addNewOperationName').fadeOut()"
						class="btn btn-success">إلغاء</button>
				</div>
			</div>
		</div>
	</div>
	<!--End AddNewOperationNameModal-->





















	<!-- Begin AddExecutorModal-->
	<div dir="rtl" class="modal" style="background: rgb(0, 0, 0, 0.4)" id="addNewExecutor">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<form class="modal-content was-validated">
				<div dir="rtl" class="modal-header bg-success text-white">
					<h4 class="modal-title" id="addNewExecutorTitle">إضافة منفذ جديد</h4>
					<button type="button" class="btn-close bg-white" style="margin-left: 0"
						onclick="$('#addNewExecutor').slideUp('fast')"></button>
				</div>
				<div class="modal-body">
					<ul class="list-group-flush">
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-lg-12">
									<label class="col-form-label col-form-label">الاسم الثلاثي</label>
									<input type="text" class="form-control form-control" id="executorName"
										placeholder="الاسم الثلاثي" required maxlength="300" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">اسم العائلة</label>
									<input type="text" class="form-control form-control" id="executorFamilyName"
										placeholder="اسم العائلة" required maxlength="50" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">الكنية</label>
									<input type="text" class="form-control form-control" id="executorNickname"
										placeholder="الكنية" maxlength="50" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div id="executorPhoneContainer" class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-9 col-form-label">الأرقام</label>
									<input dir="rtl" type="text" class="form-control executorPhone number col-3 form-control"
										placeholder="رقم جوال/هاتف" onkeypress="return inputTypeNumber(event)" maxlength="15"
										minlength="9" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">العنوان</label>

									<input autocomplete="off" type="text" class="form-control form-control" id="executorAddress"
										placeholder="العنوان" maxlength="100" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">العمر</label>
									<div class="dropdown">
										<button id="executorAge" type="button" style="min-width: 120px"
											class="btn btn-success dropdown-toggle"
											onclick="$(this).next().slideToggle('fast')">العمر</button>
										<div id="ageContainer" class="dropdown-menu">
											<a class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#ageContainer').slideUp('fast').children().removeClass('active');if(is)$('#age').text('العمر'); else $(this).addClass('active').parent().prev().text($(this).text());">طفل</a><a
												class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#ageContainer').slideUp('fast').children().removeClass('active');if(is)$('#age').text('العمر'); else $(this).addClass('active').parent().prev().text($(this).text());">شاب</a><a
												class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#ageContainer').slideUp('fast').children().removeClass('active');if(is)$('#age').text('العمر'); else $(this).addClass('active').parent().prev().text($(this).text());">عجوز</a>
										</div>
									</div>
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">التقييم</label>
									<div class="dropdown">
										<button id="executorRate" type="button" style="min-width: 120px"
											class="btn btn-success dropdown-toggle"
											onclick="$(this).next().slideToggle('fast')">التقييم</button>
										<div id="rateContainer" class="dropdown-menu">
											<a class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#rateContainer').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('التقييم'); else $(this).addClass('active').parent().prev().text($(this).text());">ممتاز</a><a
												class="dropdown-item btn btn-success" onclick="let is = $(this).hasClass('active');$('#rateContainer').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('التقييم'); 
															 else $(this).addClass('active').parent().prev().text($(this).text());">جيد جدا</a>
											<a class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#rateContainer').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('التقييم'); else $(this).addClass('active').parent().prev().text($(this).text());">جيد</a><a
												class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#rateContainer').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('التقييم'); else $(this).addClass('active').parent().prev().text($(this).text());">مقبول</a><a
												class="dropdown-item btn btn-success"
												onclick="let is = $(this).hasClass('active');$('#rateContainer').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('التقييم'); else $(this).addClass('active').parent().prev().text($(this).text());">ضعيف</a>
										</div>
									</div>
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div id="careerOrProductContainer" class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">مهنة أو منتج</label>

									<input type="text" class="form-control executorCareerOrProduct form-control"
										placeholder="مهنة أو منتج" maxlength="100" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">المستوى الدراسي</label>

									<input type="text" class="form-control form-control" id="executorAcademy"
										placeholder="المستوى الدراسي" maxlength="50" />
								</div>
							</div>
						</li>
						<li class="list-group-item text-success">
							<div id="accountNumberContainer" class="form-group row">
								<div class="col-12">
									<label class="col-form-label col-form-label">رقم حساب مصرفي</label>
									<input type="text" class="form-control executorAccountNumber form-control"
										placeholder="رقم حساب مصرفي" maxlength="100" />
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div dir="ltr" id="btnDiv" class="btn-group btn-group-lg">
					<button id="btnAdd" type="submit" class="btn btn-warning">
						<span style="display: none" class="spinner-border spinner-border-sm"></span>
						إضافة
					</button>
					<button id="btnCansel" type="button" onclick="$('#addNewExecutor').slideUp('fast');"
						class="btn btn-success">إلغاء</button>
				</div>
			</form>
		</div>
	</div>
	<!-- END AddExecutorModal-->










	<!--Begin SearchExecutorModal-->
	<div dir="rtl" class="modal" style="background: rgb(0, 0, 0, 0.4);" id="searchExecutorModal">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<form class="modal-content">
				<div dir="rtl" class="modal-header bg-success text-white">
					<h4 class="modal-title" id="searchExecutorModalTitle">حدد منفذ</h4>
					<button type="button" class="btn-close bg-white" style="margin-left: 0"
						onclick="$('#searchExecutorModal').slideUp('fast')"></button>
				</div>
				<div class="modal-body">
					<div class="form-group row m-2 mb-4">
						<div class="d-flex">
							<div class="w-75 d-inline m-1">
								<input type="text" class="form-control form-control" id="searchExecutorModalInput"
									placeholder="بحث" onkeyup="searchExecutorBaseOn($(this).val(),executors);" />
							</div>
							<div class="w-25 d-inline m-1">
								<input class="btn btn-success w-100" value="اضافة" type="button"
									onclick="$('#searchExecutorModal').slideUp('fast',()=>showAddExecutorModal());" />
							</div>
						</div>
					</div>
					<ul class="list-group-flush">
						<!--Persons will loaded here by javascript-->
					</ul>
				</div>
				<div dir="ltr" id="btnDiv" class="btn-group btn-group-lg">
					<button type="submit" class="btn btn-warning"> تحديد </button>
					<button type="button" onclick="$('#searchExecutorModal').slideUp('fast');"
						class="btn btn-success">إلغاء</button>
				</div>
			</form>
		</div>
	</div>
	<!--End SearchExecutorModal-->














	<!--######################### Add Operation ########################-->
	<form dir="rtl" class="my-5 mx-5 was-validated" autocomplete="off" id="addOperation">
		<div class="form-group row my-3">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">العملية</label>
			<div class="col-sm-10 autocomplete">
				<div class="dropdown">
					<button style="width:150px" type="button" class="btn btn-success dropdown-toggle"
						onclick="$(this).next().slideToggle('fast')">
						حدد العملية
					</button>
					<div id="operationName" class="dropdown-menu">
						<div class="dropdown-divider"></div><a style="cursor:pointer;" class="dropdown-item btn btn-success"
							onclick="$(this).parent().slideUp('fast');$('#addNewOperationName').slideDown('fast');">إضافة
							عملية...</a>
					</div>
				</div>
			</div>
		</div>


		<div class="form-group row my-3">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">تفاصيل العملية</label>
			<div class="col-sm-10">
				<textarea type="text" class="form-control form-control" id="details"
					placeholder="تفاصيل العملية"></textarea>
			</div>
		</div>


		<div class="form-group row my-3">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">ملاحظات</label>
			<div class="col-sm-10">
				<textarea type="text" class="form-control form-control" id="notes" placeholder="ملاحظات"></textarea>
			</div>
		</div>


		<div class="form-group  my-3">
			<div class="row">
				<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">المستفيد</label>
				<div class="col-sm-10">
					<input style="width:150px;" type="button" class="form-control text-white bg-success form-control"
						id="executorSearch" onclick="$('#searchExecutorModal').slideDown('fast');" value="بحث" />
				</div>
			</div>
			<div id="executorInfo" class="d-none">
				<div class="row  my-2">

					<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">الاسم كامل</label>
					<div class="col-sm-4">
						<input type="button" disabled class="form-control form-control" id="inputExecutorName"
							placeholder="الاسم الثلاثي" />
					</div>
					<div class="col-sm-3">
						<input type="button" disabled class="form-control form-control" id="inputExecutorFamilyName"
							placeholder="اللقب" />
					</div>
					<div class="col-sm-3">
						<input type="button" disabled class="form-control form-control" id="inputExecutorNickname"
							placeholder="الكنية" />
					</div>

				</div>
				<div>
					<div id="addOperationExecutorPhoneContainer" class="form-group row my-3 d-flex">
						<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">رقم المستفيد</label>
						<!-- below is each number-->

					</div>
				</div>
			</div>
		</div>


		<div class="form-group row">
			<!-- <div > -->
			<label class="col-form-label col-sm-2 col-form-label">العملة</label>

			<div class="dropdown col-sm-10">
				<button id="rate" type="button" style="min-width: 150px" class="btn btn-success dropdown-toggle"
					onclick="$(this).next().slideToggle('fast')">يمني</button>
				<div id="currency" class="dropdown-menu">
					<a class="dropdown-item btn btn-success active"
						onclick="let is = $(this).hasClass('active');$('#currency').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('حدد العملة'); else $(this).addClass('active').parent().prev().text($(this).text());">يمني</a>
					<a class="dropdown-item btn btn-success"
						onclick="let is = $(this).hasClass('active');$('#currency').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('حدد العملة'); else $(this).addClass('active').parent().prev().text($(this).text());">سعودي</a>
					<a class="dropdown-item btn btn-success"
						onclick="let is = $(this).hasClass('active');$('#currency').slideUp('fast').children().removeClass('active');if(is)$('#rate').text('حدد العملة'); else $(this).addClass('active').parent().prev().text($(this).text());">دولار</a>
				</div>
			</div>
			<!-- </div> -->
		</div>



		<div class="form-group row my-3">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">سعر التوصيل</label>
			<div class="col-sm-10">
				<input type="text" class="form-control form-control" maxlength="8" id="deliveryPrice" autocomplete="off"
					onkeypress="return inputTypeNumber(event)" placeholder="0" />
			</div>
		</div>

		<div class="form-group row my-3">
			<label for="colFormLabelSm" maxlength="8" required class="col-sm-2 col-form-label col-form-label">سعر اجمالي
				العملية</label>
			<div class="col-sm-10">
				<input type="text" class="form-control form-control" maxlength="8" id="totalPrice" autocomplete="off"
					onkeypress="return inputTypeNumber(event)" placeholder="0" />
			</div>
		</div>



		<div class="form-group row my-3 custom-control custom-radio">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">حالة الدفع</label>
			<div class="custom-control col-sm-3 custom-radio custom-control-inline">
				<input type="radio" class="custom-control-input" id="paid" name="example" value="customEx" />
				<label class="custom-control-label" for="paid">مدفوع</label>
			</div>
			<div class="custom-control col-sm-3 custom-radio custom-control-inline">
				<input type="radio" class="custom-control-input" checked id="doubt" name="example" value="customEx" />
				<label class="custom-control-label" for="doubt">آجل</label>
			</div>
			<div class="custom-control col-sm-3 custom-radio custom-control-inline">
				<input type="radio" class="custom-control-input" id="reminder" name="example" value="customEx" />
				<label class="custom-control-label" for="reminder">متبقي</label>
			</div>
		</div>
		<div class="form-group d-none row my-3">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">مدفوع من العملية</label>
			<div class="col-sm-6">
				<input type="text" class="form-control form-control" maxlength="8" id="totalPaid" autocomplete="off"
					placeholder="0" onkeypress="return inputTypeNumber(event)" />
			</div>
			<div class="col-sm-2">
				متبقي: <span dir="ltr" class="paid text-danger">0</span>
			</div>
		</div>
		<div class="form-group row my-3">
			<label for="colFormLabelSm" class="col-sm-2 col-form-label col-form-label">الربح</label>
			<div class="col-sm-10">
				<input type="text" maxlength="8" class="form-control form-control" id="profit" autocomplete="off"
					onkeypress="return inputTypeNumber(event)" placeholder="0" />
			</div>
		</div>

		<div class="form-group row my-3">
			<div class="col-sm-12">
				<button dir='ltr' id='btnAddOperation' type="submit" class="btn w-100 btn-success btn-lg btn-block"
					name="submit">
					<span style="display: none" class="spinner-border spinner-border"></span>
					تعديل العملية
				</button>
			</div>
		</div>
	</form>

	<script>
		"use strict";
	//when ready some code will execute but in addOperation.js file

		async function setOperationInfoToBeEdit() {
			let id = Number(location.href.split('=')[1]);
			console.log(id)
			newOperation = await getOperationById(id).catch(err => { console.log('err', err); Alert((err.msg || "حدث خطأ في جلب معلومات العملية"), "danger", null, () => location.href = '/'); })
			if (newOperation) {
				setHtmlOperation(newOperation);
			}

		}

		function setHtmlOperation(op) {
			console.log({ op })
			$("#operationName").prev().text(op.name);
			$("#details").val(op.details);
			$("#notes").val(op.notes);
			op.deliveryPrice = Number(op.deliveryPrice)
			$("#deliveryPrice").val((op.deliveryPrice));
			op.totalPrice = Number(op.totalPrice)
			$("#totalPrice").val((op.totalPrice));
			op.totalPaid = Number(op.totalPaid)
			$("#totalPaid").val((op.totalPaid));
			op.profit = Number(op.profit)
			$("#profit").val((op.profit));
			$("#currency").prev().text(op.currency);
			if (op.totalPrice == op.totalPaid) {
				$("#paid").attr('checked', 'checked');
			} else if (op.totalPaid == 0) {
				$("#doubt").attr('checked', 'checked');
			} else {
				$("#reminder").attr('checked', 'checked');
				$("#totalPaid").parent().parent().removeClass("d-none");
			}
			var isDoubt = $('#doubt:checked').val() ? true : false;
			var isReminder = $('#reminder:checked').val() ? true : false;
			// if (op.applicantId) {
			// 	setApplicant({
			// 		id: op.applicantId,
			// 		name: op.applicantName,
			// 		familyName: op.applicantFamilyName,
			// 		nickname: op.applicantNickname,
			// 		phone: op.applicantPhone
			// 	});
			// 	$('#applicantSearch').val('تعديل');
			// 	let contactId = $('#searchApplicantModal').find('.contactId');
			// 	for (let i = 0; i < contactId.length; i++)
			// 		if (contactId.eq(i).text() == op.applicantId.toString()) {
			// 			contactId.eq(i).parent().parent().parent().addClass('active');
			// 			break;
			// 		}

			// }
			if (op.executorId) {
				setExecutor({
					id: op.executorId,
					name: op.executorName,
					familyName: op.executorFamilyName,
					nickname: op.executorNickname,
					phone: op.executorPhone
				});
				$('#executorSearch').val('تعديل');
				let contactId = $('#searchExecutorModal').find('.contactId');
				for (let i = 0; i < contactId.length; i++)
					if (contactId.eq(i).text() == op.executorId.toString()) {
						contactId.eq(i).parent().parent().parent().addClass('active');
						break;
					}
			}
		}

	</script>
	<script>//functions
		function submitEditOperation(e) {
			e.preventDefault();
			$("#btnAddOperation").attr("disabled", "disabled").find("span").css("display", "inline-block");

			newOperation.name = $("#operationName").prev().text().trim();
			if (newOperation.name == 'حدد العملية')
				newOperation.name = null;
			newOperation.details = $('#details').val().trim();
			newOperation.notes = $('#notes').val().trim();

			let { deliveryPrice, totalPrice, profit, totalPaid, currency } = getAllPricesAtt();
			newOperation.deliveryPrice = deliveryPrice;
			newOperation.totalPrice = totalPrice;
			newOperation.profit = profit;
			newOperation.totalPaid = totalPaid;
			newOperation.currency = currency.trim() == 'حدد العملة' ? null : currency.trim();
			//----------------------------
			console.log({ newOperation })
			//validation------------------
			if (!newOperation.name||newOperation.name == 'حدد العملية') {
				$("#btnAddOperation").removeAttr("disabled").find("span").css("display", "none");
				return Alert('يجب تحديد اسم العملية!', 'danger');
			}
			if (!newOperation.executorId) {
				$("#btnAddOperation").removeAttr("disabled").find("span").css("display", "none");
				return Alert('يجب تحديد مستفيد!', 'danger');
			}
			if (!newOperation.currency||newOperation.currency == 'حدد العملة') {
				$("#btnAddOperation").removeAttr("disabled").find("span").css("display", "none");
				return Alert('يجب تحديد العملة!', 'danger');
			}
			//-------------------------

			$.ajax({
				url: "/api/operation",
				method: 'PATCH',
				data: newOperation,
				success: (res) => {
					$("#btnAddOperation").removeAttr("disabled").find("span").css("display", "none");
					console.log('patch:/api/operation', res);
					if (res.success) {
						Alert("تم التعديل بنجاح", 'success', null, () => location.href = '/operations')
					} else {
						console.log(res);
						Alert((res.msg || "حدث خطأ ما! عند تعديل العملية"), 'danger')
					}
				},
				error: (e) => {
					console.log(e);
					Alert((e.msg || "حدث خطأ ما! عند تعديل العملية"), 'danger');
				}
			});
		}



		function getOperationById(id) {
			return new Promise((resolve, reject) => {
				console.log('id', id);
				if (!id)
					return reject("id is undefined won't send to the server", id);
				$.ajax({
					url: '/api/operation',
					method: 'put',
					dataType: 'json',
					data: { id },
					success: (res) => {
						console.log('res', res);
						if (res.success)
							return resolve(res.data);
						else return reject(res);
					}, error: (res) => reject(res),
				})
			});
		}
	</script>
</body>

</html>